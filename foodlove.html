<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/bootstrap-select.css">
    <style>
        body {
        padding-top: 10px;
        padding-left: 10px;
        padding-right: 10px;
        }

    </style>
</head>

<body>

   
        <div class="form-group row">    
            <div class="col-sm-3">
                <label>縣市</label>
                <select class="selectpicker form-control" id="city" data-container="body" data-live-search="true" title="請選擇縣市" data-hide-disabled="true">
                    
                    <option value="臺北市">臺北市</option>
                    <option value="新北市">新北市</option>
                </select>
            </div>
            <div class="col-sm-3">
                <label>行政區</label>
                <select class="selectpicker form-control" id="area" data-container="body" data-live-search="true" title="請選擇地區" data-hide-disabled="true">
      
                </select>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-3"> 
                <input type="text" class="form-control" id="keyword" placeholder="搜尋字串">
            </div>
            <div class="col-sm-3">    
                <button class="btn btn-primary" onclick="javascript:getStore();">搜尋</button>
            </div>
        </div>

<div id="storelist">

</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script src="js/bootstrap-select.js"></script>

<script>

$('#city').on('change', function () {
    $('#area').find('option').remove().end();
    var sitem = $('#city').find('option:selected').val();
    var areas = cityObject[sitem];
    areas.forEach(a => $('#area').append('<option value="'+a+'">'+a+'</option>') );
    $("#area").selectpicker("refresh");
});


function getStore() {
    
    $('#storelist').find('p').remove().end();
    var cors = 'https://cors-anywhere.herokuapp.com/';
    var city = $('#city').find('option:selected').val();
    var area = $('#area').find('option:selected').val();
    var url = cors + "https://foodlover.tw/goodfood/query/shop/v2?category=餐飲&city=" + city + "&area=" + area;

    $('#storelist').append('<button class="btn btn-primary" type="button" disabled>  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>  Loading... </button>');

    $.ajax({
          url: url,
          type: 'GET',
          dataType: 'json',
          contentType:'application/json',
          crossDomain: true ,
          headers: {
            'Access-Control-Allow-Origin': '*',
          },
          beforeSend: function (xhr) {
            xhr.setRequestHeader ("Authorization", "Basic " + btoa(""));
          },
          success: function (data){    
            $('#storelist').find('button').remove().end();         
            showStore(data);
          },
          error: function(xhr, status, error) {
            $('#storelist').find('button').remove().end(); 
                console.log(status + '; ' + error);
          }
    })
}

 function showStore(data) {
    
    data.forEach(function(item) {
        var shopName = item["shop"];
        var addr = item["market_address"];
        var keyword = $("#keyword").val();
        var newElement = '<p>'+ shopName + ' / <a target="_blank" href="https://www.google.com.tw/maps/place/' + addr + '">' + addr + '</a></p>';
        if (keyword != "") {
            if (shopName.includes(keyword) || addr.includes(keyword)) {
                $('#storelist').append(newElement);
            }
        } else {
            $('#storelist').append(newElement);
        }
    });
 }
/*
      fetch(url, { mode: "no-cors" })
        .then(function(response) {
            return response.json();
        })
        .then(function(myJson) {
            alert(myJson);
            //console.log(myJson);
        });


        var result = fetchJsonp(url, {
      jsonpCallbackFunction: 'search_results',
      timeout: 3000
    })
    result.then(function (response) {
      console.log(response)
      return response.json()
    }).then(function (json) {
      console.log('parsed json', json)
    }).catch(function (ex) {
      console.log('parsing failed', ex)
    })
*/



const cityObject = {
				"所有縣市": [],
				"臺北市": ["內湖區", "中山區", "中正區", "信義區",  "北投區", "南港區", "士林區", "大同區", "大安區", "文山區", "松山區", "萬華區"],
				"新北市": ["汐止區", "三峽區", "三芝區", "三重區", "中和區", "五股區", "八里區", "土城區", "坪林區", "平溪區", "新店區", "新莊區", "板橋區", "林口區",
					"樹林區", "永和區",  "泰山區", "淡水區", "深坑區", "烏來區", "瑞芳區", "石碇區", "石門區", "萬里區", "蘆洲區", "貢寮區", "金山區",
					"雙溪區", "鶯歌區"],
				"基隆市": ["七堵區", "中山區", "中正區", "仁愛區", "信義區", "安樂區", "暖暖區"],
				"桃園市": ["中壢區", "八德區", "大園區", "大溪區", "平鎮區", "復興區", "新屋區", "桃園區", "楊梅區", "蘆竹區", "觀音區", "龍潭區", "龜山區"],
				"新竹市": ["北區", "東區", "香山區"],
				"新竹縣": ["竹北市", "竹東鎮", "新埔鎮", "關西鎮", "新豐鄉", "峨眉鄉", "寶山鄉", "五峰鄉", "橫山鄉", "北埔鄉", "尖石鄉", "芎林鄉", "湖口鄉"],
				"苗栗縣": ["三灣鄉", "三義鄉", "公館鄉", "卓蘭鎮", "南庄鄉", "大湖鄉", "後龍鎮", "泰安鄉", "獅潭鄉", "竹南鎮", "苑裡鎮", "苗栗市", "西湖鄉",
					"通霄鎮", "造橋鄉", "銅鑼鄉", "頭份市", "頭屋鄉"],
				"臺中市": ["中區", "北區", "北屯區", "南區", "南屯區", "后里區", "和平區", "外埔區", "大安區", "大甲區", "大肚區", "大里區", "潭子區", "大雅區",
					"太平區", "新社區", "東勢區", "東區", "梧棲區", "沙鹿區", "清水區", "烏日區", "石岡區", "神岡區", "西區", "西屯區", "豐原區", "霧峰區", "龍井區"],
				"彰化縣": ["二林鎮", "二水鄉", "伸港鄉", "北斗鎮", "和美鎮", "員林市", "埔心鄉", "埔鹽鄉", "埤頭鄉", "大城鄉", "大村鄉", "彰化市", "永靖鄉", "溪州鄉",
					"溪湖鎮", "田中鎮", "田尾鄉", "社頭鄉", "福興鄉", "秀水鄉", "竹塘鄉", "線西鄉", "芬園鄉", "花壇鄉", "芳苑鄉", "鹿港鎮"],
				"南投縣": ["中寮鄉", "仁愛鄉", "信義鄉", "南投市", "名間鄉", "國姓鄉", "埔里鎮", "水里鄉", "竹山鎮", "草屯鎮", "集集鎮", "魚池鄉", "鹿谷鄉"],
				"雲林縣": ["二崙鄉", "元長鄉", "北港鎮", "口湖鄉", "古坑鄉", "四湖鄉", "土庫鎮", "大埤鄉", "崙背鄉", "斗六市", "斗南鎮", "東勢鄉", "林內鄉", "水林鄉",
					"臺西鄉", "莿桐鄉", "虎尾鎮", "褒忠鄉", "西螺鎮", "麥寮鄉"],
				"嘉義市": ["東區", "西區"],
				"嘉義縣": ["中埔鄉", "六腳鄉", "大埔鄉", "大林鎮", "太保市", "布袋鎮", "新港鄉", "朴子市", "東石鄉", "梅山鄉", "民雄鄉", "水上鄉", "溪口鄉", "番路鄉",
					"竹崎鄉", "義竹鄉", "阿里山鄉", "鹿草鄉"],
				"臺南市": ["七股區", "下營區", "中西區", "仁德區", "佳里區", "六甲區", "北區", "北門區", "南區", "善化區", "大內區", "學甲區", "安南區", "安定區", "安平區",
					"官田區", "將軍區", "山上區", "左鎮區", "後壁區", "新化區", "新市區", "新營區", "東區", "柳營區", "楠西區", "歸仁區", "永康區", "玉井區", "白河區",
					"西港區", "關廟區", "鹽水區", "麻豆區", "龍崎區"],
				"高雄市": ["三民區", "仁武區", "內門區", "六龜區", "前金區", "前鎮區", "大寮區", "大樹區", "大社區", "小港區", "岡山區", "左營區", "彌陀區", "新興區",
					"旗山區", "旗津區", "杉林區", "林園區", "桃源區", "梓官區", "楠梓區", "橋頭區", "永安區", "湖內區", "燕巢區", "田寮區", "甲仙區", "美濃區", "苓雅區",
					"茂林區", "茄萣區", "路竹區", "那瑪夏區", "阿蓮區", "鳥松區", "鳳山區", "鹽埕區", "鼓山區"],
				"屏東縣": ["三地門鄉", "九如鄉", "佳冬鄉", "來義鄉", "內埔鄉", "南州鄉", "屏東市", "恆春鎮", "新園鄉", "新埤鄉", "春日鄉", "東港鎮", "枋寮鄉", "枋山鄉",
					"林邊鄉", "泰武鄉", "潮州鎮", "牡丹鄉", "獅子鄉", "琉球鄉", "瑪家鄉", "竹田鄉", "萬丹鄉", "萬巒鄉", "車城鄉", "里港鄉", "長治鄉", "霧臺鄉", "高樹鄉",
					"鹽埔鄉", "麟洛鄉"],
				"宜蘭縣": ["三星鄉", "五結鄉", "冬山鄉", "南澳鄉", "員山鄉", "壯圍鄉", "大同鄉", "宜蘭市", "礁溪鄉", "羅東鎮", "蘇澳鎮", "頭城鎮"],
				"花蓮縣": ["光復鄉", "吉安鄉", "壽豐鄉", "富里鄉", "新城鄉", "玉里鎮", "瑞穗鄉", "秀林鄉", "花蓮市", "萬榮鄉", "豐濱鄉", "鳳林鎮"],
				"臺東縣": ["卑南鄉", "大武鄉", "太麻里鄉", "延平鄉", "成功鎮", "東河鄉", "池上鄉", "海端鄉", "綠島鄉", "臺東市", "蘭嶼鄉", "達仁鄉", "金峰鄉", "長濱鄉",
					"關山鎮", "鹿野鄉"],
				"澎湖縣": ["七美鄉", "望安鄉", "湖西鄉", "白沙鄉", "西嶼鄉", "馬公市"],
				"金門縣": ["烈嶼鄉", "金城鎮", "金寧鄉", "金沙鎮", "金湖鎮"],
				"連江縣": ["北竿鄉", "南竿鄉", "東引鄉"]
			}
</script>
</body>

</html>