<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js' type='text/javascript'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" />

    <style>

        .upload-demo .upload-demo-wrap,
        .upload-demo .upload-result,
        .upload-demo.ready .upload-msg {
            display: none;
        }

        .upload-demo.ready .upload-demo-wrap {
            display: block;
        }

        .upload-demo.ready .upload-result {
            display: inline-block;
        }

        .upload-demo-wrap {
            width: 500px;
            height: 300px;
            margin: 0 auto;
        }

        .upload-msg {
            text-align: center;
            padding: 50px;
            font-size: 22px;
            color: #aaa;
            width: 260px;
            margin: 50px auto;
            border: 1px solid #aaa;
        }
    </style>
</head>

<body>
    <form id="form1" action="upload" method="post" enctype="multipart/form-data">

        <div class="form-group col-md-6">
            <label for="uname">使用者名稱</label>
            <input type="text" class="form-control" name="Uname" placeholder="">
        </div>

        <div class="row col-md-6">
            <div class="col">
                <label for="exampleFormControlFile1">上傳照片</label>
            </div>
            <div class="col">
                <input type="file" class="form-control-file" data-toggle="modal" data-target="#exampleModal" name="exampleFormControlFile1" id="exampleFormControlFile1">
            </div>
        </div>

        <div class="form-group col-md-6">
            <img id="exampleFormControlFile1Result" src="" />
            <input type="hidden" name="exampleFormControlFile1Crop" id="exampleFormControlFile1Crop" />
        </div>

        <div class="form-group col-md-6">
            <button type="submit" class="btn btn-primary">Submit</button>
        </div>
    </form>

    <div class="modal fade modal-lg" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">上傳檔案選取範圍</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="demo-wrap upload-demo">
                        <div class="container">
                            <div class="upload-msg">
                                上傳檔案選取範圍
                            </div>
                            <div class="upload-demo-wrap">
                                <div id="upload-demo"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveCropImgBtn" data-dismiss="modal">確認</button>
                </div>
            </div>
        </div>
    </div>
</body>
<script lang="javascript">
        var currentImg;

    function popupResult(result) {    
        $('#' + result.id + "Result").attr('height', 250);
        $('#' + result.id + "Result").attr('width', 400);
            $('#' + result.id + "Result").attr('src', result.src);
            $('#' + result.id + "Crop").val(result.src);
        }


        var $uploadCrop = $('#upload-demo').croppie({
            viewport: {
                width: 400,
                height: 250
            },
            enableExif: true
        });

        function readFile(input) {
            currentImg = input.id;
            if (input.files && input.files[0]) {
                var reader = new FileReader();

                reader.onload = function (e) {
                    $('.upload-demo').addClass('ready');
                    $uploadCrop.croppie('bind', {
                        url: e.target.result
                    }).then(function () {
                        console.log('jQuery bind complete');
                    });

                }

                reader.readAsDataURL(input.files[0]);
            }
            else {
                alert("Sorry - you're browser doesn't support the FileReader API");
            }
        }

        $('#exampleFormControlFile1').on('change', function () { readFile(this); });
        $('#saveCropImgBtn').on('click', function (ev) {
            $uploadCrop.croppie('result', {
                type: 'canvas',
                size: 'viewport'
            }).then(function (resp) {
                popupResult({
                    src: resp,
                    id: currentImg
                });
            });
        });

</script>
</html>